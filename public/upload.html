<!DOCTYPE html>
<html lang="en">
<head>
    <title>Upload Your Files</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="upload.css">

    <script src="https://www.gstatic.com/firebasejs/6.3.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.1/firebase-database.js"></script>
    <script src="jquery-3.4.1.js"></script>
    <script src="firebase.js"></script>
    <script>
        /*var firebaseConfig = {
            apiKey: "AIzaSyAzI4irPRxcI8zNCdz980szVpHV_uvLVi0",
            authDomain: "store-a-byte.firebaseapp.com",
            databaseURL: "https://store-a-byte.firebaseio.com",
            projectId: "store-a-byte",
            storageBucket: "gs://store-a-byte.appspot.com/",
            messagingSenderId: "909604223499",
            appId: "1:909604223499:web:aed92c7863f43569"
        };
        firebase.initializeApp(firebaseConfig);*/

        /*try {
            let firebase = firebase.app("store-a-byte");

        } catch (error) {
            var firebaseConfig = {
                apiKey: "AIzaSyAzI4irPRxcI8zNCdz980szVpHV_uvLVi0",
                authDomain: "store-a-byte.firebaseapp.com",
                databaseURL: "https://store-a-byte.firebaseio.com",
                projectId: "store-a-byte",
                storageBucket: "gs://store-a-byte.appspot.com/",
                messagingSenderId: "909604223499",
                appId: "1:909604223499:web:aed92c7863f43569"
            };
            firebase.initializeApp(firebaseConfig);
        }*/
        
        //upload files
        $(function() {
            var form = $('form');
            form.submit( function(event){
                event.preventDefault()
                var timeStamp =  Number(new Date());

                firebase.auth().onAuthStateChanged(function (user) {
                    if (user) {
                        
                        var $ = jQuery;
                        var file_data = $('#browseBtn').prop('files')[0];

                        var filePath = '/users/'+user.uid+'/'+file_data.name;
                        var storageRef = defaultStorage.ref(filePath);
                        storageRef.put(file_data).then(function() {
                            console.log("after image uploading");
                            //get download url
                            storageRef = defaultStorage.ref('/users/'+user.uid+'/')
                            storageRef.child(file_data.name).getDownloadURL().then(function(url){
                                //push data to a database under users/uid/file_url/file
                                writeUserData(user.uid, url, removeExtension(file_data.name), file_data.lastModifiedDate, file_data.size);
                            });
                        });


                    }
                    else {
                        alert("user not logged in");
                    }
                });
                
            });
        });
        
        

        
        $(document).ready(function () { 
            var localUserData;
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    localUserData = user;

                    //retrieve files when database is updated
                    var filesRef = database.ref('users/' + localUserData.uid);
                        filesRef.on('value', function(snapshot) {
                        console.log(snapshot.val());
                    
                    });
                }else {
                    console.log("user not logged in");
                }
            });

            


            $('#firebaseShowFilesTest').on('click', function(event) {
                event.preventDefault()

                

                console.log( getFileMetadataWithURL(defaultStorage, "gs://store-a-byte.appspot.com/1565197771120") );
            });
        });


        function removeExtension(filename){
            var lastDotPosition = filename.lastIndexOf(".");
            if (lastDotPosition === -1) return filename;
            else return filename.substr(0, lastDotPosition);
        }

        function writeUserData(userId, fileURL, fileName, fileDateModified, fileSize) {
            database.ref('users/' + userId+'/'+fileName).set({
                file_url: fileURL,
                modified_date: fileDateModified,
                file_size: fileSize
            });
        }

        function listAllFiles(storage, userID) {
            // Create a reference under which you want to list
            var listRef = storage.ref().child('/users/'+userID+'/');
            console.log("listref: " + listRef);
            // Find all the prefixes and items.
            listRef.listAll().then(function(res) {
            res.prefixes.forEach(function(folderRef) {
                // All the prefixes under listRef.
                // You may call listAll() recursively on them.
            });
            res.items.forEach(function(itemRef) {
                console.log(itemRef);
            });
            }).catch(function(error) {
            // Uh-oh, an error occurred!
            });
        }

        function getFileMetadataWithURL(storage, url) {
            // Create a reference to the file whose metadata we want to retrieve
            var fileRef = storage.refFromURL(url);
            // Get metadata properties
            return(fileRef.getMetadata())
        }



    </script>

</head>
<body>
    <form action="">
            <input type="file" id="browseBtn" name="avatar" accept="*, image/png, image/jpeg">
            
            <button type=”submit” id="submitFile">Upload File</button>
            <button id="firebaseShowFilesTest">Get Files</button>
            
    </form>

    
    <div class="divider">


        <h1 class="heading center">Store-A-Byte</h1>
        <div id="absolute">


            <h1>Dark Theme</h1>
            <label class="switch">
                <input type="checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>
    <hr>

    <div id="myProgress">
        <div id="myBar"></div>
    </div>


    <hr>
    <button>
        oppen Files/Folders
    </button>
    <footer>
        <button id="TheFolder">Folder #1</button>
    </footer>
    <p id="demo"></p>
    <button id="myBtn" value="" onclick="myFunction()">Try it</button>
</body>
</html>